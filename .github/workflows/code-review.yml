name: Automatic Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
      - master
      - develop

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  code-review:
    name: Automated Code Review
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v41
        with:
          files: |
            **/*.js
            **/*.ts
            **/*.jsx
            **/*.tsx
            **/*.py
            **/*.java
            **/*.go
            **/*.rb
            **/*.php
            **/*.cs
            **/*.cpp
            **/*.c
            **/*.h

      - name: Review changed files
        if: steps.changed-files.outputs.any_changed == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const changedFiles = '${{ steps.changed-files.outputs.all_changed_files }}'.split(' ');

            // Review patterns to check
            const reviewPatterns = [
              {
                pattern: /console\.log|print\(|println\(|System\.out/,
                message: 'âš ï¸ Debug statement detected. Consider removing before merging.',
                severity: 'warning'
              },
              {
                pattern: /TODO|FIXME|HACK/i,
                message: 'ðŸ“ TODO/FIXME comment found. Consider creating an issue to track this.',
                severity: 'info'
              },
              {
                pattern: /password|secret|api[_-]?key|access[_-]?token/i,
                message: 'ðŸ”’ Potential sensitive information detected. Please verify this is not exposing secrets.',
                severity: 'warning'
              },
              {
                pattern: /\.only\(|fdescribe|fit\(/,
                message: 'âš ï¸ Focused test detected (.only, fdescribe, fit). This may skip other tests.',
                severity: 'warning'
              }
            ];

            let reviewComments = [];
            let summaryComments = [];
            let errorMessages = [];

            for (const file of changedFiles) {
              if (!file) continue;

              try {
                // Get file content
                const { data: fileContent } = await github.rest.repos.getContent({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  path: file,
                  ref: context.payload.pull_request.head.sha
                });

                const content = Buffer.from(fileContent.content, 'base64').toString('utf-8');
                const lines = content.split('\n');

                // Check each line for patterns
                lines.forEach((line, index) => {
                  reviewPatterns.forEach(({ pattern, message, severity }) => {
                    if (pattern.test(line)) {
                      summaryComments.push({
                        file,
                        line: index + 1,
                        message,
                        severity,
                        code: line.trim()
                      });
                    }
                  });
                });
              } catch (error) {
                console.log(`Could not read file ${file}: ${error.message}`);
                errorMessages.push(`Could not analyze ${file}: ${error.message}`);
              }
            }

            // Post review summary as a comment
            if (summaryComments.length > 0 || errorMessages.length > 0) {
              let commentBody = '## ðŸ¤– Automated Code Review\n\n';

              if (summaryComments.length > 0) {
                commentBody += `Found ${summaryComments.length} item(s) to review:\n\n`;

                summaryComments.forEach(({ file, line, message, severity, code }) => {
                  const icon = severity === 'warning' ? 'âš ï¸' : 'â„¹ï¸';
                  commentBody += `${icon} **${file}:${line}**\n`;
                  commentBody += `   ${message}\n`;
                  commentBody += `   \`\`\`\n   ${code}\n   \`\`\`\n\n`;
                });
              }

              if (errorMessages.length > 0) {
                commentBody += '\n### âš ï¸ Analysis Errors\n\n';
                errorMessages.forEach(msg => {
                  commentBody += `- ${msg}\n`;
                });
              }

              commentBody += '\n---\n*This is an automated review. Please verify the suggestions before making changes.*';

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: commentBody
              });

              console.log(`Posted review with ${summaryComments.length} comments and ${errorMessages.length} errors`);
            } else {
              // Post a positive comment if no issues found
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: '## ðŸ¤– Automated Code Review\n\nâœ… No common issues detected in the changed files. Great job!'
              });

              console.log('No issues found - posted positive feedback');
            }

      - name: Code Quality Summary
        if: always()
        run: |
          echo "::notice::Automatic code review completed"
          echo "Changed files reviewed: ${{ steps.changed-files.outputs.all_changed_files }}"
